#!/bin/bash

# Thanks to Olov Lassus for inspiration: https://github.com/olov/node-harmony-wrapper

rdlkf() {
    [ -L "$1" ] && (local lk="$(readlink "$1")"
    local d="$(dirname "$1")"
    cd "$d"
    local l="$(rdlkf "$lk")"
    ([[ "$l" = /* ]] && echo "$l" || echo "$d/$l")) || echo "$1"
}

notFound() {
    echo "Grunt binary not found. Please reinstall the grunth-cli package."
    exit 1
}

resolveDir() {
    cd "$1"
    echo "$(pwd -P)"
}

DIR="$(dirname "$(rdlkf "$0")")/.."
if [ -d "$DIR/node_modules/" ]; then
    DIR="$DIR/node_modules/"
fi
DIR="$(resolveDir "$DIR")"

while [ ! -f "$DIR/.bin/grunt" ] && [ ! -f "$DIR/bin/grunt" ]; do
    DIR="$(resolveDir "$DIR/..")"
    if [ "$DIR" == "/" ]; then
        notFound
    fi
done

if [ -f "$DIR/.bin/grunt" ]; then
    GRUNT_PATH="$DIR/.bin/grunt"
elif [ -f "$DIR/.bin/grunt" ]; then
    GRUNT_PATH="$DIR/bin/grunt"
else
    notFound
fi

/usr/bin/env node --harmony_scoping "$GRUNT_PATH" $*
